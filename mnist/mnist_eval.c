#include <stdio.h>
#include <stdlib.h>
#include <float.h>
#include <stdint.h>

const char* params_filename = "params.bin";

const char* image_7 = "\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x54\xb9\x9f\x97\x3c\x24\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\xde\xfe\xfe\xfe\xfe\xf1\xc6\xc6\xc6\xc6\xc6\xc6\xc6\xc6\xaa\x34\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x43\x72\x48\x72\xa3\xe3\xfe\xe1\xfe\xfe\xfe\xfa\xe5\xfe\xfe\x8c\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x11\x42\x0e\x43\x43\x43\x3b\x15\xec\xfe\x6a\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x53\xfd\xd1\x12\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x16\xe9\xff\x53\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x81\xfe\xee\x2c\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3b\xf9\xfe\x3e\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x85\xfe\xbb\x05\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x09\xcd\xf8\x3a\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7e\xfe\xb6\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x4b\xfb\xf0\x39\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x13\xdd\xfe\xa6\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xcb\xfe\xdb\x23\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x26\xfe\xfe\x4d\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xe0\xfe\x73\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x85\xfe\xfe\x34\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3d\xf2\xfe\xfe\x34\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x79\xfe\xfe\xdb\x28\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x79\xfe\xcf\x12\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\
";

// structure of params.bin
typedef struct {
    float fc1_weight[401408];  // 512 x 784
    float fc1_bias[512];
    float fc2_weight[5120];  // 10 x 512
    float fc2_bias[10];
} Params;

#define L0_SIZE 784
#define L1_SIZE 512
#define L2_SIZE 10

float dot_product(const float* w, const float* x, size_t count) {
    float accum = 0.0f;
    for (size_t i = 0; i < count; i++) {
        accum += w[i] * x[i];
    }
    return accum;
}

// w is matrix with rows x cols elements, x is a vector with cols elements.
// out is a vector with rows elements.
void mat_mul_vec(float* out, const float* w, const float* x, size_t rows, size_t cols) {
    for (size_t r = 0; r < rows; r++) {
        out[r] = dot_product(&w[r * cols], x, cols);
    }
}

float relu(float x) {
    return x > 0.0f ? x : 0.0f;
}

int argmax(const float* x, size_t count) {
    float max = -FLT_MAX;
    int max_i = 0;
    for (size_t i = 0; i < count; i++) {
        if (x[i] > max) {
            max = x[i];
            max_i = i;
        }
    }
    return max_i;
}

int eval_model(const Params* p_params, const char* image) {

    // convert image to flaot
    float fimage[L0_SIZE];
    for (size_t i = 0; i < L0_SIZE; i++) {
        fimage[i] = (float)(uint8_t)image[i];
    }

    // layer 1
    float l1[L1_SIZE];
    mat_mul_vec(l1, p_params->fc1_weight, fimage, L1_SIZE, L0_SIZE);

    for (int i = 0; i < L1_SIZE; i++) {
        l1[i] = relu(l1[i] + p_params->fc1_bias[i]);
    }

    // layer 2
    float l2[L2_SIZE];
    mat_mul_vec(l2, p_params->fc2_weight, l1, L2_SIZE, L1_SIZE);
    for (int i = 0; i < L2_SIZE; i++) {
        l2[i] += p_params->fc2_bias[i];
    }

    return argmax(l2, L2_SIZE);
}

int main(int argc, const char* argv[])
{
    // allocate params
    Params* p_params = malloc(sizeof(Params));

    // load params from file
    FILE* fp = fopen(params_filename, "rb");
    size_t bytes_read = fread(p_params, 1, sizeof(Params), fp);
    if (bytes_read != sizeof(Params)) {
        printf("Error reading file, result = %ld, expected = %ld\n", bytes_read, sizeof(Params));
        return 1;
    }
    fclose(fp);

    // execute model
    int result = eval_model(p_params, image_7);
    printf("expected 7, result = %d\n", result);

    free(p_params);
    return 0;
}
